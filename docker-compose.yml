services:
  nzcvm_webapp_backend:
    build:
      context: . # Build context is the root directory
      dockerfile: docker/nzcvm_webapp_backend/Dockerfile # Path to the backend Dockerfile
    image: earthquakesuc/nzcvm_webapp_backend # Image name for build/push
    container_name: nzcvm_webapp_backend # Simplified container name
    # No ports exposed directly to host; Nginx will proxy
    # Mount the large NZCVM data directory on the host machine to the required
    # location in the container. This allows the backend to access the data
    # without needing to copy it into the container image. 
    volumes:
      - /mnt/mantle_data/nzcvm_webapp_data/data:/usr/local/lib/python3.12/site-packages/velocity_modelling/data
      # Optional: Add volumes for development to sync code without rebuilding
      # volumes:
      - ./app.py:/app/app.py
    # Connect this service to the custom bridge network defined below.
    # This allows other containers on the same network (like the frontend)
    # to reach this service using its name ('nzcvm_webapp_backend') as a hostname.
    networks:
      - nzcvm_network

  nzcvm_webapp_frontend:
    build:
      context: . # Build context is the root directory
      dockerfile: docker/nzcvm_webapp_frontend/Dockerfile # Path to the frontend Dockerfile
    image: earthquakesuc/nzcvm_webapp_frontend # Image name for build/push
    container_name: nzcvm_webapp_frontend # Simplified container name
    ports:
      - "8888:80" # Map host port 8888 to container port 80 (Nginx)
    depends_on:
      - nzcvm_webapp_backend
    # Optional: Add volumes for development to sync code without rebuilding
    volumes:
      - ./index.html:/usr/share/nginx/html/index.html
      - ./css:/usr/share/nginx/html/css
      - ./js:/usr/share/nginx/html/js
      - ./data:/usr/share/nginx/html/data

    # Connect this service to the custom bridge network.
    # This allows Nginx in this container to proxy requests to the backend
    # using 'http://nzcvm_webapp_backend:5000'.
    networks:
      - nzcvm_network

# Define a custom bridge network for the services.
# Containers attached to the same custom bridge network can communicate
# with each other using their service names as DNS hostnames.
networks:
  nzcvm_network:
    driver: bridge
